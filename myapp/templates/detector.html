<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bird Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Blue Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <button id="sidebarToggle" class="md:hidden">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h1 class="text-xl font-bold">Live Bird Detection</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm">Welcome back, John!</span>
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-4 h-4"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-0">
            <div class="flex flex-col h-full pt-16 md:pt-0">
                <!-- Sidebar Header -->
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Menu</h2>
                    <button id="sidebarClose" class="md:hidden">
                        <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                    </button>
                </div>
                
                <!-- Sidebar Content -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="{% url 'user_dashboard' %}" 
                      class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-white bg-blue-600 rounded-lg">
                        <i data-lucide="camera" class="w-5 h-5"></i>
                        <span>Live Detection</span>
                    </a>
                      <a href="{% url 'upload_history' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <span>My Detections</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Settings</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="help-circle" class="w-5 h-5"></i>
                        <span>Help</span>
                    </a>
                </nav>
                
                <!-- Logout Button -->
                <div class="p-4 border-t">
                    <a href="#" class="flex items-center space-x-3 w-full px-4 py-3 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-0 overflow-auto">
            <div class="p-6">
                <!-- Camera Detection Card -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-green-500 text-white p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Real-Time Bird Detection</h2>
                                <p class="text-blue-100">AI-powered bird identification using your camera</p>
                            </div>
                            <div class="hidden lg:block">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i data-lucide="camera" class="w-8 h-8"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Stream -->
                    <div class="p-6">
                        <div class="relative w-full max-w-4xl mx-auto h-[480px] rounded-xl border-2 border-gray-200 overflow-hidden shadow-lg bg-black">
                            <!-- Frontend Camera Video -->
                            <video id="camera" autoplay playsinline class="w-full h-full object-cover"></video>
                            <!-- Overlay Canvas for Bounding Boxes -->
                            <canvas id="overlay" class="absolute top-0 left-0 w-full h-full"></canvas>
                        </div>

                        <!-- Detection Status -->
                        <div class="flex items-center justify-center mt-4 space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-sm text-gray-600">Detection Active</span>
                            </div>
                            <button id="viewBirdBtn" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md transition-colors hidden flex items-center space-x-2">
                                <i data-lucide="info" class="w-4 h-4"></i>
                                <span>View Bird Info</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bird Info Panel -->
                <div id="bird-info" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                            <i data-lucide="feather" class="w-5 h-5 text-green-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Bird Detected</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-500">Name</label>
                                <p id="birdName" class="text-lg font-semibold text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Scientific Name</label>
                                <p id="birdScientificName" class="text-lg text-gray-700"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Population</label>
                                <p id="birdPopulation" class="text-lg text-gray-700"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Description</label>
                                <p id="birdDescription" class="text-gray-700 leading-relaxed"></p>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <img id="birdImage" class="rounded-lg shadow-md max-w-full h-auto hidden"/>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }

        sidebarToggle.addEventListener('click', openSidebar);
        sidebarClose.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar on window resize if desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                closeSidebar();
            }
        });

        // Bird Detection JavaScript - Preserved from original
        const video = document.getElementById("camera");
        const viewBtn = document.getElementById("viewBirdBtn");
        let latestBird = null;

        // Start camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: "environment" } }, // ✅ rear camera
                    audio: false
                });
                video.srcObject = stream;
            } catch (err) {
                console.warn("Rear camera not available, falling back to default:", err);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                } catch (err2) {
                    console.error("Error accessing camera:", err2);
                    alert("❌ Cannot access camera. Please allow camera permission.");
                }
            }
        }

        // Send frames to backend for detection
        async function detectBird() {
            if (!video.srcObject || video.videoWidth === 0) return;

            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.8));
            if (!blob) return;

            try {
                const formData = new FormData();
                formData.append("frame", blob);

                const res = await fetch("{% url 'predict_bird' %}", {
                    method: "POST",
                    body: formData,
                });

                const data = await res.json();
                const overlay = document.getElementById("overlay");
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
                const octx = overlay.getContext("2d");
                octx.clearRect(0, 0, overlay.width, overlay.height);

                if (data.birds && data.birds.length > 0) {
                    data.birds.forEach(bird => {
                        const [x1, y1, x2, y2] = bird.bbox;

                        // Draw bounding box
                        octx.strokeStyle = "lime";
                        octx.lineWidth = 3;
                        octx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                        // Draw label
                        octx.fillStyle = "lime";
                        octx.font = "18px Arial";
                        octx.fillText(bird.name, x1, y1 - 5);
                    });

                    latestBird = data.birds[0]; // take first detection
                    viewBtn.classList.remove("hidden");
                } else {
                    latestBird = null;
                    viewBtn.classList.add("hidden");
                    document.getElementById("bird-info").classList.add("hidden");
                }

            } catch (err) {
                console.error("Detection error:", err);
            }
        }

        // When button clicked -> show info + save to BirdPhoto
        viewBtn.addEventListener("click", () => {
            if (!latestBird) return;

            // Just show the info panel
            document.getElementById("bird-info").classList.remove("hidden");
            document.getElementById("birdName").textContent = latestBird.name;
            document.getElementById("birdScientificName").textContent = latestBird.scientific_name || "Unknown";
            document.getElementById("birdPopulation").textContent = latestBird.population || "Unknown";
            document.getElementById("birdDescription").textContent = latestBird.description || "No description";

            if (latestBird.image_url) {
                const imgEl = document.getElementById("birdImage");
                imgEl.src = latestBird.image_url;
                imgEl.classList.remove("hidden");
            }
        });

        // Start camera on load
        startCamera();

        // Poll backend every 2s (adjust to smaller interval for smoother real-time)
        setInterval(detectBird, 2000);
    </script>
</body>
</html>