{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50">

<!-- Header -->
<header class="bg-blue-600 text-white shadow-lg fixed top-0 inset-x-0 z-50">
  <div class="flex items-center justify-between px-6 py-4">
    <div class="flex items-center space-x-4">
      <button id="sidebarToggle" class="md:hidden">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>
      <h1 class="text-xl font-bold">Detection History</h1>
    </div>
    <div class="flex items-center space-x-4">
      <span class="text-sm">Welcome, {{ user.username }}!</span>
      <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
        <i data-lucide="user" class="w-4 h-4"></i>
      </div>
    </div>
  </div>
</header>

<!-- Layout -->
<div class="flex pt-16 h-screen">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-0">
    <div class="flex flex-col h-full pt-16">
      <div class="flex items-center justify-between p-4 border-b">
        <h2 class="text-lg font-semibold text-gray-800">Menu</h2>
        <button id="sidebarClose" class="md:hidden">
          <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
        </button>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-2">
        <a href="{% url 'user_dashboard' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="home" class="w-5 h-5"></i>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'upload_history' %}" class="flex items-center space-x-3 px-4 py-3 text-white bg-blue-500 rounded-lg">
          <i data-lucide="clock" class="w-5 h-5"></i>
          <span>My Detections</span>
        </a>
         <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Settings</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="help-circle" class="w-5 h-5"></i>
                        <span>Help</span>
                    </a>
      </nav>
      <div class="p-4 border-t">
        <a href="{% url 'logout' %}" class="flex items-center space-x-3 w-full px-4 py-3 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          <span>Logout</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 overflow-auto p-6">
    <div class="bg-white rounded-xl shadow p-6 max-w-6xl mx-auto">
      <h2 class="text-2xl font-semibold text-blue-600 mb-4 text-center">Bird Detection History</h2>

      <div class="overflow-x-auto rounded-lg">
        <table class="min-w-full table-auto border text-center text-sm">
          <thead class="bg-blue-100 text-blue-800 uppercase font-semibold">
            <tr>
              <th class="py-3 px-4">Photo</th>
              <th class="py-3 px-4">Bird Detected</th>
              <th class="py-3 px-4">Uploaded At</th>
            </tr>
          </thead>
          <tbody id="uploadTableBody" class="text-gray-700">
            {% for photo in user_photos %}
            <tr class="border-t hover:bg-gray-50 transition table-row">
              <td class="p-3">
                <img src="{{ photo.photo.url }}" alt="Bird Photo" class="h-24 mx-auto rounded-md shadow" />
              </td>
              <td>
                {% if photo.bird %}
                <span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                  {{ photo.bird.name }}
                </span>
                {% else %}
                <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                  Not Detected
                </span>
                {% endif %}
              </td>
              <td class="p-3">{{ photo.uploaded_at }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="py-6 text-center text-gray-500">
                <i data-lucide="camera-off" class="w-8 h-8 mx-auto mb-2 text-gray-400"></i>
                No uploads yet. Start by uploading your first bird photo!
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex justify-between items-center mt-4">
        <ul class="pagination flex space-x-2 text-sm">
          <li class="prev text-gray-400 cursor-not-allowed"><a href="#" class="px-3 py-1 rounded border">←</a></li>
          <!-- Page links will be inserted here -->
          <li class="next text-gray-700"><a href="#" class="px-3 py-1 rounded border">→</a></li>
        </ul>
        <div class="page-info text-sm text-gray-500">
          Showing <span id="startItem">0</span> to <span id="endItem">0</span> of <span id="totalItems">0</span> entries
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  lucide.createIcons();

  document.getElementById("sidebarToggle").addEventListener("click", () => {
    document.getElementById("sidebar").classList.remove("-translate-x-full");
  });

  document.getElementById("sidebarClose").addEventListener("click", () => {
    document.getElementById("sidebar").classList.add("-translate-x-full");
  });

  // Pagination Script
  document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll(".table-row");
    const paginationUl = document.querySelector(".pagination");
    const prevBtn = paginationUl.querySelector(".prev");
    const nextBtn = paginationUl.querySelector(".next");
    const pageInfo = document.querySelector(".page-info");

    const itemsPerPage = 5;
    const totalItems = rows.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    let currentPage = 1;

    function renderPaginationLinks() {
      paginationUl.querySelectorAll("li:not(.prev):not(.next)").forEach(el => el.remove());

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#";
        a.dataset.page = i;
        a.textContent = i;
        a.className = "px-3 py-1 rounded border hover:bg-blue-100";

        if (i === currentPage) {
          a.classList.add("bg-blue-500", "text-white");
        }

        li.appendChild(a);
        paginationUl.insertBefore(li, nextBtn);
      }
    }

    function showPage(pageNum) {
      const start = (pageNum - 1) * itemsPerPage;
      const end = start + itemsPerPage;

      rows.forEach((row, i) => {
        row.style.display = i >= start && i < end ? "" : "none";
      });

      document.getElementById("startItem").textContent = totalItems ? start + 1 : 0;
      document.getElementById("endItem").textContent = totalItems ? Math.min(end, totalItems) : 0;
      document.getElementById("totalItems").textContent = totalItems;

      currentPage = pageNum;
      renderPaginationLinks();

      prevBtn.classList.toggle("text-gray-400", currentPage === 1);
      prevBtn.classList.toggle("cursor-not-allowed", currentPage === 1);
      nextBtn.classList.toggle("text-gray-400", currentPage === totalPages);
      nextBtn.classList.toggle("cursor-not-allowed", currentPage === totalPages);
    }

    paginationUl.addEventListener("click", function (e) {
      const target = e.target;
      if (target.tagName !== "A") return;
      e.preventDefault();

      const page = parseInt(target.dataset.page);

      if (target.closest("li").classList.contains("prev") && currentPage > 1) {
        showPage(currentPage - 1);
      } else if (target.closest("li").classList.contains("next") && currentPage < totalPages) {
        showPage(currentPage + 1);
      } else if (page) {
        showPage(page);
      }
    });

    // Initialize
    if (totalItems > 0) {
      showPage(1);
    } else {
      pageInfo.textContent = "No entries to display";
    }
  });
</script>
</body>
</html>
