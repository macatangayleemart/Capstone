{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Blue Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <button id="sidebarToggle" class="md:hidden">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h1 class="text-xl font-bold">Dashboard</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm">Welcome back, John!</span>
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-4 h-4"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-0">
            <div class="flex flex-col h-full pt-16 md:pt-0">
                <!-- Sidebar Header -->
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-800">Menu</h2>
                    <button id="sidebarClose" class="md:hidden">
                        <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                    </button>
                </div>
                
                <!-- Sidebar Content -->
                <nav class="flex-1 px-4 py-6 space-y-2">
                   <a href="{% url 'upload_history' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <span>My Detections</span>
                    </a>

                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Settings</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="help-circle" class="w-5 h-5"></i>
                        <span>Help</span>
                    </a>
                </nav>
                
                <!-- Logout Button -->
                        <div class="p-4 border-t">
                <a href="{% url 'logout' %}" class="flex items-center space-x-3 w-full px-4 py-3 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span>Logout</span>
                </a>
            </div>

            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-0 overflow-auto">
            <div class="p-6">
                <!-- Big Long Stat Card - System Introduction -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-8 mb-6 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold mb-4">Welcome to Your Dashboard</h2>
                                <p class="text-blue-100 mb-4 max-w-2xl">
                                    This intelligent monitoring dashboard is designed to 
                                    support the Department of Environment and Natural Resources 
                                    (DENR) in protecting the rich biodiversity of Naujan Lake. 
                                    It provides real-time bird detection capabilities using computer 
                                    vision and machine learning to help identify, classify, and monitor 
                                    avian species in the area. Gain actionable insights, review detection history, 
                                    and contribute to informed conservation efforts through a centralized, user-friendly platform.
                                </p>
                        </div>
                        <div class="hidden lg:block">
                            <div class="w-32 h-32 bg-white bg-opacity-20 rounded-full flex items-center justify-center overflow-hidden">
                                <img src="{% static 'images/banner-img.png' %}" alt="Banner" class="w-full h-full object-cover" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Three Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Total Uploads -->
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Detections Made</p>
                                <p id="total-uploads-count" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600"></i>
                            </div>
                        </div>
                    </div>


                    <!-- Most Captured Bird Stat Card -->
                    <div id="most-captured-bird-card" class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Most Captured Bird</p>
                                <p id="bird-name" class="text-2xl font-bold text-gray-900 mt-2">Loading...</p>
                                <div class="flex items-center mt-2">
                                    <i data-lucide="camera" class="w-4 h-4 text-blue-500 mr-1"></i>
                                    <span id="bird-month" class="text-gray-500 text-sm">this month</span>
                                </div>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i data-lucide="feather" class="w-8 h-8 text-blue-600"></i>
                            </div>
                        </div>
                    </div>


                                            <!-- Birds in Database -->
                        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Total Birds</p>
                                    <p id="bird-count" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                                    <div class="flex items-center mt-2">
                                        <i data-lucide="trending-up" class="w-4 h-4 text-green-500 mr-1"></i>
                                        <span class="text-green-500 text-sm font-medium">+0%</span>
                                        <span class="text-gray-500 text-sm ml-1">from last month</span>
                                    </div>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <i data-lucide="feather" class="w-8 h-8 text-green-600"></i>
                                </div>
                            </div>
                        </div>

                </div>

                <!-- Additional Content Area -->
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Recent Activity -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl h-[400px]">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">My Bird Detection Stats</h2>
                            <canvas id="userDetectionChart" class="w-full h-full"></canvas>
                        </div>

                   <!-- Quick Actions -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                               <button onclick="openBirdModal()" class="flex flex-col items-center justify-center p-4 h-32 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <i data-lucide="eye" class="w-8 h-8 text-blue-600 mb-2"></i>
                                    <span class="text-sm font-medium text-gray-700">View Birds Quickly</span>
                                </button>


                                <a href="{% url 'detector' %}" class="flex flex-col items-center justify-center p-4 h-32 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <i data-lucide="folder" class="w-8 h-8 text-green-600 mb-2"></i>
                                    <span class="text-sm font-medium text-gray-700">Detector</span>
                                </a>

                                <button class="flex flex-col items-center justify-center p-4 h-32 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <i data-lucide="settings" class="w-8 h-8 text-purple-600 mb-2"></i>
                                    <span class="text-sm font-medium text-gray-700">Settings</span>
                                </button>

                                <button class="flex flex-col items-center justify-center p-4 h-32 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <i data-lucide="help-circle" class="w-8 h-8 text-orange-600 mb-2"></i>
                                    <span class="text-sm font-medium text-gray-700">Get Help</span>
                                </button>
                            </div>
                        </div>

                </div>
            </div>
        </main>
    </div>

                    <!-- Bird List Modal -->
                <div id="bird-list-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Birds List</h2>
                            <button onclick="closeBirdModal()" class="text-gray-500 hover:text-gray-700">
                                ✕
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left text-gray-700">
                                <thead>
                                    <tr>
                                        <th class="py-2 px-4">Photo</th>
                                        <th class="py-2 px-4">Name</th>
                                    </tr>
                                </thead>
                                <tbody id="bird-list-table">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
        fetch("/user-detection-stats/")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById("userDetectionChart").getContext("2d");

                const chart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: "Detections",
                            data: data.counts,
                            backgroundColor: [
                                '#60A5FA', '#818CF8', '#34D399', '#FBBF24',
                                '#F87171', '#A78BFA', '#F472B6', '#5EEAD4', '#FCD34D'
                            ],
                            borderRadius: 10,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#F3F4F6'  // light gray
                                },
                                ticks: {
                                    stepSize: 1,
                                    precision: 0,
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#111827',
                                titleFont: {
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                padding: 10,
                                cornerRadius: 6
                            }
                        }
                    }
                });
            })
            .catch(error => console.error("Chart error:", error));
    });


        // Initialize Lucide icons
        lucide.createIcons();

        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }

        sidebarToggle.addEventListener('click', openSidebar);
        sidebarClose.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar on window resize if desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                closeSidebar();
            }
        });

        
    fetch('/api/user-upload-count/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-uploads-count').textContent = data.total_uploads;
        });
             
        
    document.addEventListener("DOMContentLoaded", () => {
    fetch("/api/most-captured-bird/")
        .then(response => response.json())
        .then(data => {
            document.getElementById("bird-name").textContent = data.bird_name;
            document.getElementById("bird-month").textContent = `in ${data.month}`;
        })
        .catch(error => {
            console.error("Error fetching bird data:", error);
            document.getElementById("bird-name").textContent = "Error loading";
        });
});

        
        document.addEventListener("DOMContentLoaded", function() {
    fetch('/api/bird-count/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('bird-count').textContent = data.count;
        })
        .catch(error => {
            console.error('Error fetching bird count:', error);
        });
});

function openBirdModal() {
    // Show modal
    document.getElementById('bird-list-modal').classList.remove('hidden');

    // Fetch birds
    fetch('/api/client-bird-list/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('bird-list-table');
            tbody.innerHTML = ''; // Clear old content

            data.birds.forEach(bird => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4">
                        <img src="${bird.image}" alt="${bird.name}" class="w-16 h-16 object-cover rounded">
                    </td>
                    <td class="py-2 px-4">${bird.name}</td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching birds:', error));
}

function closeBirdModal() {
    document.getElementById('bird-list-modal').classList.add('hidden');
}
    </script>
</body>
</html>